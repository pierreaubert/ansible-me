user  pierre pierre;
worker_processes  2;

error_log  /var/log/nginx/error.log;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

# server
http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    gzip  on;

    server_tokens off;
    proxy_hide_header X-Powered-By;

    add_header Strict-Transport-Security "max-age=31536000; includeSubdomains;";
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://ssl.google-analytics.com https://assets.zendesk.com https://connect.facebook.net; img-src 'self' https://ssl.google-analytics.com https://s-static.ak.facebook.com https://assets.zendesk.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://assets.zendesk.com; font-src 'self' https://themes.googleusercontent.com; frame-src https://assets.zendesk.com https://www.facebook.com https://s-static.ak.facebook.com https://tautt.zendesk.com; object-src 'none'";

    # HTTPS server
    #
    server {
        listen       443;
        server_name  7pi.eu;

        ssl                  on;
        ssl_certificate      /etc/ssl/private/7pi.eu/cert-chain.pem;
        ssl_certificate_key  /etc/ssl/private/7pi.eu/cert.key;

        ssl_prefer_server_ciphers on;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout  10m;
        ssl_ciphers 'EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH EDH+aRSA RC4:HIGH !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS';
        #ssl_ciphers  HIGH:!aNULL:!MD5;

        # enable ocsp stapling (mechanism by which a site can convey certificate revocation information to visitors in a privacy-preserving, scalable manner)
        # http://blog.mozilla.org/security/2013/07/29/ocsp-stapling-in-firefox/
        ssl_stapling on;
        ssl_trusted_certificate /etc/ssl/private/7pi.eu/cert-chain.pem;
        # google resolver?
        resolver 8.8.8.8;

	access_log /var/log/nginx/access-7pi.log;
	error_log /var/log/nginx/error-7pi.log;

        # main static files
        location / {
            root   /home/pierre/src/7pi.eu/;
	    try_files $uri $uri/ /index.html;
        }

        # apis
        location /apis/sso {
                 proxy_pass http://127.0.0.1:9090/;
                 proxy_redirect off;

                 proxy_set_header Host            $host;
                 proxy_set_header X-Real-IP       $remote_addr;
                 proxy_set_header X-Forwarder-For $proxy_add_x_forwarded_for;
        }

        location /apis/rssfeeds {
                 proxy_pass http://127.0.0.1:9091/;
                 proxy_redirect off;

                 proxy_set_header Host            $host;
                 proxy_set_header X-Real-IP       $remote_addr;
                 proxy_set_header X-Forwarder-For $proxy_add_x_forwarded_for;
        }

        location /apis/userfeeds {
                 proxy_pass http://127.0.0.1:9092/;
                 proxy_redirect off;

                 proxy_set_header Host            $host;
                 proxy_set_header X-Real-IP       $remote_addr;
                 proxy_set_header X-Forwarder-For $proxy_add_x_forwarded_for;
        }
       
        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

    # redirect all http traffic to https
    server {
        listen 80;
        server_name .7pi.eu;
        rewrite ^ https://$host$request_uri permanent;
    }
}

